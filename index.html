
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="0E8UTUVy2SC9q5opV85mwrTUA2yWV0y+s2/Urr1FSI8tNoGroQMdBi8/0CFNRHApTEzvH7FOshC+AYBKdkicyQ==" />
    
    <meta name="action-cable-url" content="wss://a.messageflow.ai/cable" />
    <script src="/packs/js/application-ea3fe00ca44fe366752e.js" data-turbolinks-track="reload"></script>
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@ricky0123/vad-web@0.0.7/dist/bundle.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/fontawesome.min.css">
      <link href="https:///live_chat/chat.css?t=2024-10-06 01:12:34 +0200" rel="stylesheet">
  </head>
  <body>
    <div class="wrapper">
      <div class="mf-live-container">
  <div class="peers fxw-nw pos-r">
    <div class="peer peer-greed" id='question' style="display:none">
      <div id="mf_actions">
        <br>
        <table width="100%">
          <tr>

            <td>&nbsp;</td>
            <td>
              <div class="question_action" onclick="$('#question').hide();$('#live_chat_container').show();$('#live_chat').scrollTop($('#live_chat')[0].scrollHeight);">
                <table>
                  <tbody>
                  <tr>
                    <td class="icon">
                      <i class="fa fa-commenting-o" style="color: red"></i>
                    </td>
                    <td>&nbsp;</td>
                    <td>
                      <h5>
                        Live chat
                      </h5>
                    </td>
                  </tr>
                  </tbody>
                </table>
              </div>
            </td>
          </tr>
        </table>
        <br>
      </div>
      <div id="mf_question" class="mf_question_container">
        <h4 class="question_header">Frage oder Anweisung:</h4>
        <p>z.B. Wie ist das Wetter in Berlin?</p>
        <textarea class="tx_question" name="ta_question" rows=5 id="ta_question"></textarea>
        <button class="btn question_btn" onclick="send_question();">
          <i class="fa fa-arrow-right"></i>
        </button>
        <br>
        <br>
      </div>
      <div id="mf_answer" class="mf_question_container">
        <table width="100%">
          <tr>
            <td style="vertical-align:top" width="50px">
              <button class="btn another_question_btn" onclick="$('#mf_question').show();$('#mf_answer').hide();$('#mf_actions').show();">
                <i class="fa fa-arrow-left"></i>
              </button>
            </td>
            <td width="10px">&nbsp;&nbsp;</td>
            <td>
              <h5>Deine Frage:</h5>
              <div id="mf_your_question"></div>
              <hr>
              <h5>Antwort:</h5>
              <div id="mf_answer_text"></div>
            </td>
          </tr>
        </table>
      </div>
      <br>
    </div>
    <!-- audio box-->
    <div class="peer peer-greed" id='audio_container' style="display:none">
      <br>
      <div class="mf_question_container">
        <table>
          <tr>
            <td>
              <div class="recording">
                <i class="fa fa-microphone"></i>
              </div>
            </td>
            <td>
              &nbsp;
            </td>
            <td>
              <div id="eq"></div>
            </td>
          </tr>
        </table>
      </div>
    </div>
    <!-- Chat Box -->
    <div id="live_chat_container" style="display:block">
      <div class="peer peer-greed" id='live-chat-box'>
  <div class="layers h-100">
    <div class="layer w-100">
      <div id="live_chat_58239" style="display:block;"></div>
      <!-- Header -->
      <div class="peers" style="padding: 20px 0px 10px 20px; background:white">
        <table width="100%">
          <tbody>
          <tr>
            <td class="icon" width="20px">
              <i id="chat-header-icon-left" class="fa fa-comments" style="color: #008dc7;font-size:20px"></i>
            </td>
            <td width="5px">&nbsp;</td>
            <td>
              <h5>
                Assistant
              </h5>
            </td>
            <td style="text-align:right">

              <button id="new_chat_btn" style="display: none; margin-right: 20px" class="btn back_btn" onclick="newChat()" title="Clear chat"><i class="fa fa-trash"></i></button>&nbsp;&nbsp;

            </td>
          </tr>
          </tbody>
        </table>
      </div>
    </div>
    <div class="layer w-100" id="live_chat" style="overflow-y: auto;height:350px;padding:10px">
      <!-- Chat Box -->
      <div class="p-20 gapY-15" id="live_chat_messages" style="padding:10px;overflow-y: auto;">
        <!-- Chat Conversation -->
        </div>
      </div>

    </div>

  </div>
  <div class="layer w-100" style="background:white;padding:10px">
    <!-- Chat Send -->
    <div class="p-20 bdT bgc-white">
      <div class="pos-r">
        <div id="chat_bot_status" class="message bg-white" style="display:none;">
          Agent tippt ...
        </div>
        <form class="simple_form new_message" id="chat_form" novalidate="novalidate" action="/messages/0/live_chat?uid=271f0d8f6f571470d7c50177a052866730960e6c" accept-charset="UTF-8" data-remote="true" method="post">
          <div class="form-group hidden message_conversation_id form-group-valid"><input class="form-control is-valid hidden" autocomplete="off" type="hidden" value="58239" name="message[conversation_id]" id="message_conversation_id" /></div>
          <div class="form-group hidden message_user_id form-group-valid"><input class="form-control is-valid hidden" autocomplete="off" type="hidden" value="26" name="message[user_id]" id="message_user_id" /></div>
          <div class="input-group mb-3">
            <input class="form-control string optional chat-input" autocomplete="off" type="text" value="" name="message[message]" id="message_message" />
            <div class="input-group-append">
              <input type="submit" name="commit" value="Senden" class="btn btn-primary chat-input" id="send_button" disabled="disabled" />
            </div>
          </div>
</form>      </div>
    </div>
  </div>
</div>
<script>

    // disable send button
    $(document).ready(() => {
        $('#chat_form').on('ajax:send', function() {
            $('#send_button').prop('disabled', true);
        });
        $('#message_message').on('input', function() {
            if ($.trim($('#message_message').val()) === '') {
                $('#send_button').prop('disabled', true);
            } else {
                $('#send_button').prop('disabled', false);
            }
        });
    });


    function closeLiveChat() {
        newChat();
    }

    function newChat() {
        reloadWithoutConversationId();
    }

    function reloadWithoutConversationId() {
        // Get the current URL
        const currentUrl = new URL(window.location.href);

        // Get the search parameters
        //const params = new URLSearchParams(currentUrl.search);

        // Delete the 'conversation_id' parameter
        //params.delete('conversation_id');

        // Construct the new URL without 'conversation_id'
        //const newUrl = `${currentUrl.origin}${currentUrl.pathname}?${params.toString()}`;

        // Reload the page with the new URL
        window.location.href = currentUrl + "&force_new=true";
    }
</script>

    </div>
    <script>
        $("#live_chat").scrollTop($("#live_chat")[0].scrollHeight);

        console.log("start live chat app");
        var conversation_id = 58239;
        var uid = "271f0d8f6f571470d7c50177a052866730960e6c";

        //
        // global variables
        //
        var html_render_section = "";
        let lprotocol = window.location.protocol; // gets the protocol (http: or https:)
        let ws_protocol = lprotocol.startsWith("https") ? "wss" : "ws";

        let lhost = window.location.hostname; // gets the host name
        let lport = window.location.port; // gets the port number

        // Combine them to get the full host URL
        let http_base_url = lprotocol + "//" + lhost + (lport ? ":" + lport : "");
        let upload_url = http_base_url + "/internal_api/uploads/upload?uid=" + uid;
        let post_url = http_base_url + "/internal_api/chat?uid=" + uid;
        var wss_url = "wss://" + lhost + "/cable?uid=" + uid;

        // global cable reference
        var cable = null;

        connect_to_websockets();

        //
        // websockets stuff
        //

        function connect_to_websockets() {
            if (cable != null)
                return;
            // Create a new WebSocket connection to the ActionCable server

            determine_conversation();
            cable = new WebSocket(wss_url);

            // When the connection is established, send a message to the server to subscribe to a channel
            cable.addEventListener('open', function (event) {
                // retrieve cookie conversation_id
                var cookies = document.cookie.split(';');
                var conversation_id = get_conversation();
                console.log("conversation_id: " + conversation_id);
                cable.send(JSON.stringify({
                    command: 'subscribe',
                    identifier: JSON.stringify({
                        channel: 'LiveChat',
                        conversation_id: conversation_id
                    })
                }));

            });

            // When a message is received from the server, handle it appropriately
            cable.addEventListener('message', function (event) {
                const message = JSON.parse(event.data);
                if (message.type === 'ping') {
                    // Ignore ping messages
                    return;
                }
                if (message.type === 'confirm_subscription') {
                    // Subscription to the channel was successful
                    console.log('Subscribed to ' + event.data + ' in frame successfully');
                    return;
                }
                if (message.type === 'reject_subscription') {
                    // Subscription to the channel was rejected
                    console.log('Subscription to MyChannel was rejected');
                    return;
                }
                // thinking ...

                // inspect message
                if (message.message == undefined)
                    return;
                else {
                    //debugger
                    let msg = message.message;
                    console.log("Received message in frame: " , msg);
                    console.log("Conversation_id in frame: " + msg.conversation_id);
                    $("#new_chat_btn").show();

                    if (msg.answer != null) {
                        $("#mf_question").hide();
                        $("#mf_answer").show();
                        document.getElementById("mf_answer_text").innerHTML = msg.message;
                        return;
                    }
                    // set cookie conversation_id
                    if ( msg.type !== 'typing' &&
                      get_conversation() == msg.conversation_id) {
                        $("#live_chat_messages").html($("#live_chat_messages").html() + "<br>" + msg.message);
                        $("#live_chat").scrollTop($("#live_chat")[0].scrollHeight);
                        if (msg.direction == "send") {
                            $("#message_message").val("");
                        }
                    }
                    if (msg.type === 'typing') {
                        debugger;
                        $("#chat_bot_status").show();
                    } else {
                        $("#chat_bot_status").hide();
                    }
                }
            });

        }

        function determine_conversation() {
        }

        function sendMsg() {
            // send to chat server
            msg = {
                command: 'message',
                identifier: JSON.stringify({channel: 'LiveChat', conversation_id: get_conversation()}),
                data: JSON.stringify(
                    {
                        message: chatWidgetInput.value
                    }
                )
            }
            cable.send(JSON.stringify(msg));
        }

        function get_conversation() {
            return conversation_id;
        }

        function send_question() {
            $("#mf_actions").hide();
            $("#mf_your_question").html($("#ta_question").val());

            var xhr = new XMLHttpRequest();
            xhr.open('POST', post_url, true);
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');

            xhr.onload = function () {
                if (xhr.status === 200) {
                    console.log("question sent");
                }
            };
            var textarea = document.getElementById("ta_question");
            xhr.send('conversation_id=' + get_conversation() + '&question=' + encodeURIComponent(textarea.value))
            $("#ta_question").val('');
        }

        //
        // audio related stuff
        //
        var recording_started = false;

        async function main() {

            const myvad = await vad.MicVAD.new({
                positiveSpeechThreshold: 0.8,
                minSpeechFrames: 5,
                preSpeechPadFrames: 10,
                onFrameProcessed: (probs) => {
                    if (recording_started == false) {
                        recording_started = true;
                        document.getElementById("eq").innerHTML = "Recording now";
                    }
                    if (probs.isSpeech > 0.8)
                        // generate a random number of | from 1 to 30 as output
                        document.getElementById("eq").innerHTML = "|".repeat(Math.floor(Math.random() * 30) + 1)
                    else
                        document.getElementById("eq").innerHTML = ""
                },
                onSpeechStart: () => {
                    document.getElementById("eq").innerHTML = "Start recording...";
                    console.log("Speech start detected")
                },
                onSpeechEnd: (arr) => {
                    document.getElementById("eq").innerHTML = "Send recording, please wait...";
                    addAudio(arr)
                }
            })
            myvad.start()
        }

        // main()

        function float32ArrayToWav(bytes, sampleRate) {
            var buffer = new ArrayBuffer(44 + bytes.length * 2);
            var view = new DataView(buffer);

            function writeString(view, offset, string) {
                for (var i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            }

            function floatTo16BitPCM(output, offset, input) {
                for (var i = 0; i < input.length; i++, offset += 2) {
                    var s = Math.max(-1, Math.min(1, input[i]));
                    output.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
                }
            }

            writeString(view, 0, 'RIFF'); // RIFF header
            view.setUint32(4, 32 + bytes.length * 2, true); // file length
            writeString(view, 8, 'WAVE'); // WAVE header
            writeString(view, 12, 'fmt '); // fmt chunk
            view.setUint32(16, 16, true); // size of fmt chunk
            view.setUint16(20, 1, true); // audio format (1 = PCM)
            view.setUint16(22, 1, true); // number of channels
            view.setUint32(24, sampleRate, true); // sample rate
            view.setUint32(28, sampleRate * 2, true); // byte rate
            view.setUint16(32, 2, true); // block align
            view.setUint16(34, 16, true); // bits per sample
            writeString(view, 36, 'data'); // data chunk
            view.setUint32(40, bytes.length * 2, true); // data length

            floatTo16BitPCM(view, 44, bytes);

            return new Blob([view], {type: 'audio/wav'});
        }

        function downloadBlob(blob, filename) {
            // Create a URL for the blob
            var url = URL.createObjectURL(blob);

            // Create a new anchor element
            var a = document.createElement('a');
            document.body.appendChild(a);

            // Set the href and download attributes for the anchor element
            a.href = url;
            a.download = filename;

            // Trigger the download by simulating a click on the anchor element
            a.click();

            // Clean up by revoking the Object URL and removing the anchor element
            URL.revokeObjectURL(url);
            a.remove();
        }


        function addAudio(audioUrl) {
            console.log("uploading audio");
            // post audioUrl data file to chat server with ajax but no jquery
            var float32Array = audioUrl;
            var wavBlob = float32ArrayToWav(float32Array, 16000);
            // downloadBlob(wavBlob, "transcript_1.wav");
            // Create a FormData object
            var formData = new FormData();
            // Append the blob to the FormData object, 'file' is the key
            formData.append('file', wavBlob, 'transcript_1.wav'); // Replace 'filename.ext' with the desired filename
            // POST the FormData to your server with additional headers (optional)
            fetch(upload_url, {
                method: 'POST',
                body: formData,
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json(); // or response.text() if your server responds with text
                })
                .then(data => {
                    console.log('Success:', data);
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }
    </script>

    </div>
  </div>
</body>
</html>
